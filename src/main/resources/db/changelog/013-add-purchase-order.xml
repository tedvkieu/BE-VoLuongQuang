<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

  <changeSet id="013-add-purchase-order" author="codex">
    <createTable tableName="purchase_order">
      <column name="purchase_order_id" type="varchar(255)">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="user_id" type="varchar(255)"/>

      <column name="customer_name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="customer_phone" type="varchar(30)">
        <constraints nullable="false"/>
      </column>
      <column name="customer_email" type="varchar(320)"/>
      <column name="customer_address" type="varchar(2000)"/>

      <column name="status" type="varchar(32)" defaultValue="NEW">
        <constraints nullable="false"/>
      </column>

      <column name="total_amount" type="numeric(12,2)"/>
      <column name="discount_amount" type="numeric(12,2)"/>
      <column name="final_amount" type="numeric(12,2)"/>

      <column name="uuid" type="varchar(36)"/>
      <column name="created_at" type="timestamp"/>
      <column name="updated_at" type="timestamp"/>
      <column name="is_deleted" type="boolean" defaultValueBoolean="false"/>
    </createTable>

    <addForeignKeyConstraint
      baseTableName="purchase_order"
      baseColumnNames="user_id"
      referencedTableName="users"
      referencedColumnNames="user_id"
      constraintName="fk_purchase_order_user"
      onDelete="SET NULL"/>

    <createIndex indexName="idx_purchase_order_user_id" tableName="purchase_order">
      <column name="user_id"/>
    </createIndex>
    <createIndex indexName="idx_purchase_order_status" tableName="purchase_order">
      <column name="status"/>
    </createIndex>
    <createIndex indexName="idx_purchase_order_created_at" tableName="purchase_order">
      <column name="created_at"/>
    </createIndex>

    <createTable tableName="purchase_order_item">
      <column name="purchase_order_item_id" type="varchar(255)">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="purchase_order_id" type="varchar(255)">
        <constraints nullable="false"/>
      </column>

      <column name="product_id" type="varchar(255)">
        <constraints nullable="false"/>
      </column>

      <column name="product_name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="product_unit" type="varchar(50)"/>
      <column name="product_image_url" type="varchar(2048)"/>

      <column name="quantity" type="int">
        <constraints nullable="false"/>
      </column>

      <column name="unit_price" type="numeric(12,2)"/>
      <column name="discount_percent" type="int"/>
      <column name="final_unit_price" type="numeric(12,2)"/>
      <column name="line_total" type="numeric(12,2)"/>
      <column name="final_line_total" type="numeric(12,2)"/>

      <column name="uuid" type="varchar(36)"/>
      <column name="created_at" type="timestamp"/>
      <column name="updated_at" type="timestamp"/>
      <column name="is_deleted" type="boolean" defaultValueBoolean="false"/>
    </createTable>

    <addForeignKeyConstraint
      baseTableName="purchase_order_item"
      baseColumnNames="purchase_order_id"
      referencedTableName="purchase_order"
      referencedColumnNames="purchase_order_id"
      constraintName="fk_purchase_order_item_order"
      onDelete="CASCADE"/>

    <addForeignKeyConstraint
      baseTableName="purchase_order_item"
      baseColumnNames="product_id"
      referencedTableName="product"
      referencedColumnNames="product_id"
      constraintName="fk_purchase_order_item_product"/>

    <createIndex indexName="idx_purchase_order_item_order_id" tableName="purchase_order_item">
      <column name="purchase_order_id"/>
    </createIndex>
    <createIndex indexName="idx_purchase_order_item_product_id" tableName="purchase_order_item">
      <column name="product_id"/>
    </createIndex>
  </changeSet>

</databaseChangeLog>

