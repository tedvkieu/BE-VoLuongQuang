<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

  <changeSet id="020-add-cart-item-variant" author="codex">
    <sql>
      -- Add surrogate primary key for cart_items so a product can appear multiple times with different variants
      ALTER TABLE cart_items ADD COLUMN IF NOT EXISTS cart_item_id BIGINT GENERATED BY DEFAULT AS IDENTITY;
      UPDATE cart_items SET cart_item_id = DEFAULT WHERE cart_item_id IS NULL;
      ALTER TABLE cart_items ALTER COLUMN cart_item_id SET NOT NULL;

      -- Switch primary key to cart_item_id
      ALTER TABLE cart_items DROP CONSTRAINT IF EXISTS cart_items_pkey;
      ALTER TABLE cart_items ADD CONSTRAINT cart_items_pkey PRIMARY KEY (cart_item_id);

      -- Add optional product variant reference
      ALTER TABLE cart_items ADD COLUMN IF NOT EXISTS product_variant_id VARCHAR(50);

      -- FK is optional; for non-variant products this column can be NULL
      ALTER TABLE cart_items DROP CONSTRAINT IF EXISTS fk_cart_items_product_variant;
      ALTER TABLE cart_items
        ADD CONSTRAINT fk_cart_items_product_variant
        FOREIGN KEY (product_variant_id)
        REFERENCES product_variant(product_variant_id)
        ON DELETE SET NULL;

      -- Prevent duplicates per (cart_id, product_id, product_variant_id)
      CREATE UNIQUE INDEX IF NOT EXISTS ux_cart_items_cart_product_variant
        ON cart_items (cart_id, product_id, COALESCE(product_variant_id, ''));
    </sql>
  </changeSet>
</databaseChangeLog>

